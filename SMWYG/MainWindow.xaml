<Window x:Class="SMWYG.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:converters="clr-namespace:SMWYG.Converters"
    Title="Group Streaming App" Height="900" Width="1600"
        Background="#202225"
        WindowState="Maximized">

    <Window.Resources>
        <converters:StringToInitialsConverter x:Key="StringToInitialsConverter"/>
        <converters:RelativePathToImageConverter x:Key="RelativePathToImageConverter"/>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:ChannelTypeToIconConverter x:Key="ChannelTypeToIconConverter"/>
    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="72" />
            <!-- Servers -->
            <ColumnDefinition Width="240" />
            <!-- Channels -->
            <ColumnDefinition Width="*" />
            <!-- Main Content -->
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="60" />
            <!-- User Profile Bar -->
        </Grid.RowDefinitions>

        <!-- 1. Servers Sidebar -->
        <ScrollViewer Grid.Column="0" Grid.Row="0" Grid.RowSpan="2"
                      Background="#202225" VerticalScrollBarVisibility="Auto">
            <StackPanel Margin="8">
                <!-- Add Server Button -->
                <Button Width="48" Height="48" Margin="0,8"
                        Background="#36393F" Foreground="#43B581"
                        FontSize="24" FontWeight="Bold"
                        Content="+"
                        Command="{Binding CreateServerCommand}"
                        ToolTip="Create New Server"/>

                <!-- Servers List -->
                <ItemsControl ItemsSource="{Binding Servers}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Vertical"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Button Width="48" Height="48" Margin="0,8"
                                    Background="#5865F2"
                                    Command="{Binding DataContext.SelectServerCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                    CommandParameter="{Binding}"
                                    ToolTip="{Binding Name}">
                                <Button.Content>
                                    <Grid ClipToBounds="True">
                                        <Image Source="{Binding Icon, Converter={StaticResource RelativePathToImageConverter}}" Stretch="UniformToFill">
                                            <Image.Style>
                                                <Style TargetType="Image">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                    <Style.Triggers>
                                                        <Trigger Property="Source" Value="{x:Null}">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Image.Style>
                                        </Image>
                                        <TextBlock Text="{Binding Name, Converter={StaticResource StringToInitialsConverter}}"
                                                   Foreground="White" FontWeight="Bold"
                                                   HorizontalAlignment="Center" VerticalAlignment="Center">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Icon}" Value="{x:Null}">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Icon}" Value="">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Grid>
                                </Button.Content>
                            </Button>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </ScrollViewer>

        <!-- 2. Channels Sidebar -->
        <ScrollViewer Grid.Column="1" Grid.Row="0"
                      Background="#2F3136" VerticalScrollBarVisibility="Auto">
            <StackPanel Margin="12,16,12,0">
                <TextBlock Text="{Binding SelectedServer.Name, StringFormat='{}Server: {0}'}"
                           Foreground="White" FontWeight="SemiBold" FontSize="16" Margin="0,0,0,12"/>

                <Button Content="Server Settings" Command="{Binding ToggleServerSettingsCommand}"
                        Padding="8,6" Margin="0,0,0,12"
                        Background="#5865F2" Foreground="White" BorderThickness="0"/>

                <Border Background="#202225" Padding="12" CornerRadius="8" Margin="0,0,0,16"
                        Visibility="{Binding IsServerSettingsOpen, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <Button Content="✕" Width="24" Height="24"
                                    Command="{Binding CloseServerSettingsCommand}"
                                    Background="Transparent" Foreground="#B9BBBE" BorderBrush="#B9BBBE"/>
                        </StackPanel>
                        <TextBlock Text="Invite Code" Foreground="#B9BBBE" FontSize="12"/>
                        <TextBox Text="{Binding ServerSettingsInviteCode}" IsReadOnly="True" Margin="0,4,0,12"
                                 Background="#2F3136" Foreground="White" BorderBrush="#40444B"/>
                        <TextBlock Text="Server Name" Foreground="#B9BBBE" FontSize="12"/>
                        <TextBox Text="{Binding ServerSettingsName, UpdateSourceTrigger=PropertyChanged}" Margin="0,4,0,12"
                                 Background="#2F3136" Foreground="White" BorderBrush="#40444B"/>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                            <Button Content="Save" Command="{Binding SaveServerSettingsCommand}"
                                    Padding="8,4" Margin="0,0,8,0"
                                    Background="#3BA55D" Foreground="White" BorderThickness="0"/>
                            <Button Content="Change Icon" Command="{Binding UpdateServerIconCommand}"
                                    Padding="8,4"
                                    Background="#7289DA" Foreground="White" BorderThickness="0"/>
                        </StackPanel>
                        <Button Content="Delete Server" Command="{Binding DeleteServerCommand}"
                                Padding="8,4"
                                Background="#D83C3E" Foreground="White" BorderThickness="0"/>
                    </StackPanel>
                </Border>

                <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                    <Button Content="Add Channel" Command="{Binding CreateChannelCommand}"
                            Padding="8,4" Margin="0,0,8,0"
                            Background="#3BA55D" Foreground="White" BorderThickness="0"/>
                    <Button Content="Remove Channel" Command="{Binding DeleteChannelCommand}"
                            Padding="8,4"
                            Background="#D83C3E" Foreground="White" BorderThickness="0"/>
                </StackPanel>

                <ItemsControl ItemsSource="{Binding Channels}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Button HorizontalContentAlignment="Left"
                                    Background="Transparent"
                                    Foreground="#B9BBBE"
                                    Padding="10,6"
                                    Margin="0,0,0,8"
                                    Command="{Binding DataContext.SelectChannelCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                    CommandParameter="{Binding}">
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="{Binding Type, Converter={StaticResource ChannelTypeToIconConverter}}"
                                               Foreground="#72767D"
                                               FontWeight="Bold"
                                               FontFamily="Segoe UI Symbol"
                                               Margin="0,0,8,0"/>
                                    <TextBlock Text="{Binding Name}"/>
                                </StackPanel>
                            </Button>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </ScrollViewer>

        <!-- 3. Main Content Area -->
        <Grid Grid.Column="2" Grid.Row="0" Background="#36393F">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Messages Area -->
            <ScrollViewer VerticalScrollBarVisibility="Auto" Grid.Row="0">
                <ItemsControl ItemsSource="{Binding Messages}" Margin="16">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Margin="0,8">
                                <StackPanel Orientation="Horizontal">
                                    <Ellipse Width="40" Height="40" Margin="0,0,12,0">
                                        <Ellipse.Fill>
                                            <ImageBrush ImageSource="{Binding Author.ProfilePicture, Converter={StaticResource RelativePathToImageConverter}}" Stretch="UniformToFill" />
                                        </Ellipse.Fill>
                                    </Ellipse>
                                    <StackPanel>
                                        <TextBlock Text="{Binding Author.Username}" FontWeight="Bold" Foreground="White"/>
                                        <TextBlock Text="{Binding SentAt, StringFormat='{}{0:HH:mm}'}" Foreground="#72767D" FontSize="10"/>
                                    </StackPanel>
                                </StackPanel>
                                <TextBlock Text="{Binding Content}" Foreground="#DCDEDF" TextWrapping="Wrap" Margin="52,4,16,0"/>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

            <!-- Message Input -->
            <TextBox Grid.Row="0" VerticalAlignment="Bottom"
                     Margin="16,0,16,16" Padding="12" FontSize="14"
                     Background="#40444B" Foreground="White"
                     BorderBrush="#292B2F" BorderThickness="1"
                     Text="{Binding MessageInput, UpdateSourceTrigger=PropertyChanged}"
                     AcceptsReturn="False">
                <TextBox.InputBindings>
                    <KeyBinding Key="Enter" Command="{Binding SendMessageCommand}"/>
                </TextBox.InputBindings>
            </TextBox>
        </Grid>

        <!-- 4. Bottom User Profile Bar -->
        <Border Grid.Column="1" Grid.ColumnSpan="2" Grid.Row="1"
                Background="#292B2F" BorderBrush="#1E1F22" BorderThickness="0,1,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="240"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal"
                            VerticalAlignment="Center" Margin="16,0">
                    <Image Height="32" Width="32" Stretch="UniformToFill" Margin="0,0,0,12"
                       Source="{Binding UserSettingsProfilePicturePath, Converter={StaticResource RelativePathToImageConverter}, FallbackValue=Assets/avatar.png, TargetNullValue=Assets/avatar.png}"/>
                    <StackPanel Margin="8,0">
                        <TextBlock Text="{Binding CurrentUser.Username}" Foreground="White" FontWeight="SemiBold"/>
                        <TextBlock Text="#1234" Foreground="#72767D" FontSize="12"/>
                    </StackPanel>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal"
                            HorizontalAlignment="Left" VerticalAlignment="Center" Margin="1128,0,0,0" Height="59">
                    <Button Content="🎤" Width="40" Height="40" Margin="4"/>
                    <Button Content="🎧" Width="40" Height="40" Margin="4"/>
                    <Button Content="⚙️" Width="40" Height="40" Margin="4"
                            Command="{Binding ToggleUserSettingsCommand}"/>
                    <Button Content="Admin" Width="80" Height="40" Margin="4"
                            Background="#5865F2" Foreground="White" BorderThickness="0"
                            Visibility="{Binding CurrentUser.IsAdmin, Converter={StaticResource BooleanToVisibilityConverter}}"
                            Command="{Binding ToggleInviteManagerCommand}"/>
                </StackPanel>
            </Grid>
        </Border>

        <Border Grid.ColumnSpan="3" Grid.RowSpan="2"
                HorizontalAlignment="Right" VerticalAlignment="Bottom"
                Margin="0,0,32,96" Padding="16"
                Background="#2F3136" BorderBrush="#1E1F22" BorderThickness="1"
                CornerRadius="8" Panel.ZIndex="20"
                Visibility="{Binding IsUserSettingsOpen, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel Width="320">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <Button Content="✕" Width="28" Height="28" Margin="0,0,0,8"
                            Command="{Binding CloseUserSettingsCommand}"
                            Background="Transparent" Foreground="#B9BBBE" BorderBrush="#B9BBBE"/>
                </StackPanel>
                <TextBlock Text="User Settings" FontSize="16" FontWeight="SemiBold" Foreground="White" Margin="0,0,0,12"/>
                <Image Height="80" Width="80" Stretch="UniformToFill" Margin="0,0,0,12"
                       Source="{Binding UserSettingsProfilePicturePath, Converter={StaticResource RelativePathToImageConverter}, FallbackValue=Assets/avatar.png, TargetNullValue=Assets/avatar.png}"/>
                <Button Content="Change Profile Picture" Command="{Binding UpdateUserProfilePictureCommand}"
                        Padding="8,4" Margin="0,0,0,16"
                        Background="#7289DA" Foreground="White" BorderThickness="0"/>
                <TextBlock Text="Username" Foreground="#B9BBBE" FontSize="12"/>
                <TextBox Text="{Binding UserSettingsUsername, UpdateSourceTrigger=PropertyChanged}" Margin="0,4,0,12"
                         Background="#40444B" Foreground="White" BorderBrush="#292B2F"/>
                <Button Content="Save" Command="{Binding SaveUserSettingsCommand}"
                        Padding="8,4" Margin="0,0,0,12"
                        Background="#3BA55D" Foreground="White" BorderThickness="0"/>
                <Button Content="Logout" Command="{Binding LogoutCommand}"
                        Padding="8,4"
                        Background="#D83C3E" Foreground="White" BorderThickness="0"/>
            </StackPanel>
        </Border>

        <Border Grid.ColumnSpan="3" Grid.RowSpan="2"
                HorizontalAlignment="Right" VerticalAlignment="Top"
                Margin="0,32,32,0" Padding="16"
                Background="#2F3136" BorderBrush="#1E1F22" BorderThickness="1"
                CornerRadius="8" Panel.ZIndex="25"
                Visibility="{Binding IsInviteManagerOpen, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel Width="420">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <Button Content="✕" Width="28" Height="28" Margin="0,0,0,8"
                            Command="{Binding ToggleInviteManagerCommand}"
                            Background="Transparent" Foreground="#B9BBBE" BorderBrush="#B9BBBE"/>
                </StackPanel>
                <TextBlock Text="Super Admin · Invite Tokens" FontSize="16" FontWeight="SemiBold" Foreground="White"/>
                <StackPanel Orientation="Horizontal" Margin="0,12,0,0">
                    <StackPanel Width="200">
                        <TextBlock Text="Max Uses" Foreground="#B9BBBE" FontSize="12"/>
                        <TextBox Text="{Binding InviteMaxUsesInput, UpdateSourceTrigger=PropertyChanged}"
                                 Background="#40444B" Foreground="White" BorderBrush="#292B2F"/>
                    </StackPanel>
                    <StackPanel Width="200" Margin="12,0,0,0">
                        <TextBlock Text="Expires In (days)" Foreground="#B9BBBE" FontSize="12"/>
                        <TextBox Text="{Binding InviteExpiryDaysInput, UpdateSourceTrigger=PropertyChanged}"
                                 Background="#40444B" Foreground="White" BorderBrush="#292B2F"/>
                    </StackPanel>
                </StackPanel>
                <Button Content="Generate Invite Token" Command="{Binding CreateInviteTokenCommand}"
                        Padding="8,6" Margin="0,12,0,0"
                        Background="#3BA55D" Foreground="White" BorderThickness="0"/>
                <ScrollViewer Margin="0,12,0,0" Height="320">
                    <ItemsControl ItemsSource="{Binding InviteTokens}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="#202225" Padding="12" CornerRadius="6" Margin="0,0,0,8">
                                    <StackPanel>
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                            <TextBox Text="{Binding Token}" IsReadOnly="True" Background="Transparent" BorderThickness="0" Foreground="White" FontWeight="SemiBold" Width="260"/>
                                            <Button Content="Copy" Margin="8,0,0,0" Padding="8,4" Width="60" Command="{Binding DataContext.CopyInviteTokenCommand, RelativeSource={RelativeSource AncestorType=Window}}" CommandParameter="{Binding Token}" Background="#5865F2" Foreground="White" BorderThickness="0"/>
                                        </StackPanel>
                                         <TextBlock Text="{Binding CreatedAt, StringFormat='{}Created: {0:yyyy-MM-dd HH:mm}'}" Foreground="#B9BBBE" FontSize="12" Margin="0,4,0,0"/>
                                         <TextBlock Text="{Binding ExpiresAt, StringFormat='{}Expires: {0:yyyy-MM-dd}', TargetNullValue='Expires: Never'}" Foreground="#B9BBBE" FontSize="12"/>
                                         <TextBlock Text="{Binding MaxUses, StringFormat='{}Max Uses: {0}'}" Foreground="#B9BBBE" FontSize="12"/>
                                         <TextBlock Foreground="#B9BBBE" FontSize="12" Margin="0,4,0,0">
                                             <TextBlock.Style>
                                                 <Style TargetType="TextBlock">
                                                     <Setter Property="Text" Value="Status: Active"/>
                                                     <Style.Triggers>
                                                         <DataTrigger Binding="{Binding IsUsed}" Value="True">
                                                             <Setter Property="Text" Value="Status: Used / Revoked"/>
                                                         </DataTrigger>
                                                     </Style.Triggers>
                                                 </Style>
                                             </TextBlock.Style>
                                         </TextBlock>
                                         <Button Content="Revoke"
                                                 Margin="0,8,0,0"
                                                 Padding="8,4"
                                                 Width="100"
                                                 Background="#D83C3E"
                                                 Foreground="White"
                                                 BorderThickness="0"
                                                 Command="{Binding DataContext.RevokeInviteTokenCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                 CommandParameter="{Binding}">
                                            <Button.Style>
                                                <Style TargetType="Button">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsUsed}" Value="True">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Button.Style>
                                        </Button>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </StackPanel>
        </Border>

        <!-- Toast notification for copy actions -->
        <Border Grid.ColumnSpan="3" Grid.RowSpan="2"
                HorizontalAlignment="Right" VerticalAlignment="Top"
                Margin="0,120,32,0" Padding="12"
                Background="#3BA55D" BorderBrush="#1E1F22" BorderThickness="1"
                CornerRadius="6" Panel.ZIndex="40"
                Visibility="{Binding CopyNotificationVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Background" Value="#3BA55D"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding CopyNotificationIsError}" Value="True">
                            <Setter Property="Background" Value="#D83C3E"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>
            <TextBlock Text="{Binding CopyNotificationText}" Foreground="White" FontWeight="SemiBold"/>
        </Border>
    </Grid>
</Window>